{% extends "base.html" %}

{% block title %}{{ book.title }} - LibraryApp{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Back Navigation -->
    <div class="row mb-3">
        <div class="col">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Catalog
            </a>
        </div>
    </div>

    <!-- Book Details -->
    <div class="row">
        <div class="col-xl-4 col-lg-5 col-md-6 mb-4">
            <div class="card glass-card sticky-top" style="top: 100px;">
                <div class="book-cover-container-large">
                    <img src="{{ book.cover_url }}" 
                         class="card-img-top book-cover-large" 
                         alt="{{ book.title }}"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22450%22 viewBox=%220 0 300 450%22><rect width=%22300%22 height=%22450%22 fill=%22%23666%22/><text x=%22150%22 y=%22225%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2224%22>No Image</text></svg>'">

                    <!-- Borrowed Status Badge -->
                    {% if is_borrowed %}
                    <div class="position-absolute top-0 end-0 m-3">
                        <span class="badge glass-badge bg-success">
                            <i class="fas fa-check me-1"></i>
                            <span class="d-none d-sm-inline">Currently </span>Borrowed
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-xl-8 col-lg-7 col-md-6">
            <div class="card glass-card">
                <div class="card-body">
                    <h1 class="card-title display-5 mb-3">{{ book.title }}</h1>

                    <div class="book-meta mb-4">
                        <h4 class="text-muted mb-3">
                            <i class="fas fa-user me-2"></i>{{ book.author }}
                        </h4>

                        <div class="row g-2 g-sm-3 mb-4">
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center flex-wrap">
                                    <i class="fas fa-tag me-2 text-muted"></i>
                                    <strong class="me-2">Category:</strong>
                                    <span class="badge bg-secondary">{{ book.category }}</span>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar me-2 text-muted"></i>
                                    <strong class="me-2">Published:</strong>
                                    <span>{{ book.publication_year }}</span>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-alt me-2 text-muted"></i>
                                    <strong class="me-2">Pages:</strong>
                                    <span>{{ book.pages }}</span>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-barcode me-2 text-muted"></i>
                                    <strong class="me-2">ISBN:</strong>
                                    <span class="text-break">{{ book.isbn }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="book-description mb-4">
                        <h5><i class="fas fa-info-circle me-2"></i>Description</h5>
                        <p class="lead">{{ book.description }}</p>
                    </div>

                    <!-- Ratings and Reviews Section -->
                    <div class="ratings-section mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h5><i class="fas fa-star me-2"></i>Ratings & Reviews</h5>
                            {% if current_user.is_authenticated %}
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleReviewForm()">
                                <i class="fas fa-plus me-1"></i>Add Review
                            </button>
                            {% endif %}
                        </div>
                        
                        <!-- Average Rating Display -->
                        <div class="rating-summary mb-3" id="rating-summary">
                            <div class="d-flex align-items-center">
                                <div class="rating-stars me-3" id="average-stars">
                                    <!-- Stars will be populated by JavaScript -->
                                </div>
                                <span class="rating-text" id="rating-text">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Review Form (Hidden by default) -->
                        {% if current_user.is_authenticated %}
                        <div class="review-form mb-4" id="review-form" style="display: none;">
                            <div class="glass-card p-3">
                                <h6>Write a Review</h6>
                                <form id="review-submit-form">
                                    <div class="mb-3">
                                        <label class="form-label">Rating</label>
                                        <div class="rating-input">
                                            <input type="radio" name="rating" value="1" id="star1">
                                            <label for="star1" class="star">★</label>
                                            <input type="radio" name="rating" value="2" id="star2">
                                            <label for="star2" class="star">★</label>
                                            <input type="radio" name="rating" value="3" id="star3">
                                            <label for="star3" class="star">★</label>
                                            <input type="radio" name="rating" value="4" id="star4">
                                            <label for="star4" class="star">★</label>
                                            <input type="radio" name="rating" value="5" id="star5">
                                            <label for="star5" class="star">★</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="review-text" class="form-label">Review</label>
                                        <textarea class="form-control glass-input" id="review-text" rows="3" 
                                                placeholder="Share your thoughts about this book..."></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary glass-button">Submit Review</button>
                                        <button type="button" class="btn btn-secondary glass-button" onclick="toggleReviewForm()">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Reviews List -->
                        <div class="reviews-list" id="reviews-list">
                            <!-- Reviews will be loaded by JavaScript -->
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        {% if current_user.is_authenticated %}
                            {% if book.poster and book.poster.id == current_user.id %}
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>This is your book:</strong> You cannot borrow your own book.
                                </div>
                                <div class="d-grid gap-2 d-sm-flex flex-wrap mb-3">
                                    <button class="btn btn-secondary btn-lg glass-button flex-fill" disabled>
                                        <i class="fas fa-user me-2"></i>Your Book
                                    </button>
                                </div>
                            {% elif not is_borrowed %}
                                <!-- Due Date Selection for User-Posted Books -->
                                {% if book.poster %}
                                <div class="mb-3">
                                    <label for="proposedDueDate" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Proposed Return Date
                                    </label>
                                    <input type="date" 
                                           class="form-control glass-input" 
                                           id="proposedDueDate" 
                                           min="{{ (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d') }}"
                                           value="{{ (datetime.now() + timedelta(weeks=2)).strftime('%Y-%m-%d') }}">
                                    <small class="text-muted">This will be sent to the book owner for approval</small>
                                </div>
                                {% endif %}

                                <div class="d-grid gap-2 d-sm-flex flex-wrap mb-3">
                                    <button class="btn btn-success btn-lg glass-button borrow-btn flex-fill" 
                                            data-book-id="{{ book.id }}"
                                            data-book-title="{{ book.title }}"
                                            data-has-owner="{{ 'true' if book.poster else 'false' }}">
                                        <i class="fas fa-download me-2"></i>
                                        {% if book.poster %}Request to Borrow{% else %}Borrow Now{% endif %}
                                    </button>
                                </div>
                            {% else %}
                                <div class="d-grid gap-2 d-sm-flex flex-wrap mb-3">
                                    <button class="btn btn-warning btn-lg glass-button return-btn flex-fill" 
                                            data-book-id="{{ book.id }}"
                                            data-book-title="{{ book.title }}">
                                        <i class="fas fa-undo me-2"></i>Return This Book
                                    </button>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Login Required:</strong> Please log in to borrow books from our library collection.
                            </div>
                            <div class="d-grid gap-2 d-sm-flex flex-wrap mb-3">
                                <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg glass-button flex-fill">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login to Borrow
                                </a>
                                <a href="{{ url_for('signup') }}" class="btn btn-outline-primary btn-lg glass-button flex-fill">
                                    <i class="fas fa-user-plus me-2"></i>Sign Up
                                </a>
                            </div>
                        {% endif %}

                        <!-- Secondary Actions -->
                        <div class="d-grid gap-2 d-sm-flex flex-wrap">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary glass-button flex-fill">
                                <i class="fas fa-user me-2"></i>
                                <span class="d-none d-sm-inline">View </span>My Books
                            </a>

                            <a href="{{ url_for('book_discussion', book_id=book.id) }}" class="btn btn-outline-secondary glass-button flex-fill">
                                <i class="fas fa-comments me-2"></i>Discussion
                            </a>

                            {% if book.poster %}
                            <a href="{{ url_for('view_poster', user_id=book.poster.id) }}" class="btn btn-outline-info glass-button flex-fill">
                                <i class="fas fa-user-circle me-2"></i>
                                <span class="d-none d-sm-inline">View </span>Poster
                            </a>
                            
                            {% if current_user.is_authenticated and book.poster.id != current_user.id %}
                            <a href="{{ url_for('private_chat', recipient_id=book.poster.id, book_id=book.id) }}" class="btn btn-outline-success glass-button flex-fill">
                                <i class="fas fa-comments me-2"></i>
                                <span class="d-none d-sm-inline">Talk to </span>Author
                            </a>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Information -->
    <div class="row mt-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info me-2"></i>Borrowing Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <h6><i class="fas fa-clock me-1"></i>Loan Period</h6>
                            <p class="mb-0">2 weeks (14 days)</p>
                        </div>
                        <div class="col-md-4 mb-3">
                            <h6><i class="fas fa-redo me-1"></i>Renewals</h6>
                            <p class="mb-0">Up to 2 renewals allowed</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Rating Stars Styling */
.rating-stars {
    display: flex;
    gap: 2px;
}

.rating-stars .star {
    color: #ffc107;
    font-size: 1.2rem;
}

.rating-stars .star.empty {
    color: #666;
}

/* Interactive Rating Input */
.rating-input {
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    gap: 5px;
}

.rating-input input[type="radio"] {
    display: none;
}

.rating-input .star {
    font-size: 2rem;
    color: #dee2e6;
    cursor: pointer;
    transition: color 0.2s ease;
}

.rating-input .star.active {
    color: #ffc107;
}

.rating-input .star.hover {
    color: #ffc107;
}

/* Review Cards */
.review-card {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 1rem;
    margin-bottom: 1rem;
}

.review-meta {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.7);
}

.review-content {
    margin-top: 0.5rem;
}

.rating-summary {
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}
</style>
{% endblock %}

{% block scripts %}
<script>
const bookId = {{ book.id }};

// Rating and Review Functions
function renderStars(rating, maxStars = 5) {
    let starsHtml = '';
    for (let i = 1; i <= maxStars; i++) {
        if (i <= rating) {
            starsHtml += '<span class="star">★</span>';
        } else {
            starsHtml += '<span class="star empty">★</span>';
        }
    }
    return starsHtml;
}

function toggleReviewForm() {
    const form = document.getElementById('review-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function loadReviews() {
    fetch(`/api/books/${bookId}/reviews`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReviews(data.reviews);
                updateRatingSummary(data.reviews);
            } else {
                console.error('Failed to load reviews:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading reviews:', error);
        });
}

function displayReviews(reviews) {
    const reviewsList = document.getElementById('reviews-list');
    
    if (reviews.length === 0) {
        reviewsList.innerHTML = '<p class="text-muted">No reviews yet. Be the first to review this book!</p>';
        return;
    }
    
    let reviewsHtml = '';
    reviews.forEach(review => {
        reviewsHtml += `
            <div class="review-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="review-header">
                        <div class="d-flex align-items-center mb-2">
                            <strong class="me-2">${review.user_full_name || review.username}</strong>
                            <div class="rating-stars me-2">
                                ${renderStars(review.rating)}
                            </div>
                            <small class="review-meta">${review.time_ago}</small>
                        </div>
                    </div>
                    ${review.user_id === {{ current_user.id if current_user.is_authenticated else 'null' }} ? 
                        `<button class="btn btn-sm btn-outline-danger" onclick="deleteReview(${review.id})">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                </div>
                ${review.review_text ? `<div class="review-content">${review.review_text}</div>` : ''}
            </div>
        `;
    });
    
    reviewsList.innerHTML = reviewsHtml;
}

function updateRatingSummary(reviews) {
    const summaryElement = document.getElementById('rating-summary');
    const starsElement = document.getElementById('average-stars');
    const textElement = document.getElementById('rating-text');
    
    if (reviews.length === 0) {
        starsElement.innerHTML = renderStars(0);
        textElement.textContent = 'No ratings yet';
        return;
    }
    
    const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);
    const averageRating = totalRating / reviews.length;
    const roundedRating = Math.round(averageRating * 10) / 10;
    
    starsElement.innerHTML = renderStars(Math.round(averageRating));
    textElement.textContent = `${roundedRating}/5 (${reviews.length} review${reviews.length !== 1 ? 's' : ''})`;
}

function submitReview() {
    const form = document.getElementById('review-submit-form');
    const formData = new FormData(form);
    const rating = formData.get('rating');
    const reviewText = document.getElementById('review-text').value.trim();
    
    if (!rating) {
        alert('Please select a rating');
        return;
    }
    
    const reviewData = {
        rating: parseInt(rating),
        review_text: reviewText
    };
    
    fetch(`/api/books/${bookId}/reviews`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reviewData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            toggleReviewForm();
            form.reset();
            loadReviews(); // Reload reviews
        } else {
            alert(data.message || 'Failed to submit review');
        }
    })
    .catch(error => {
        console.error('Error submitting review:', error);
        alert('Failed to submit review');
    });
}

function deleteReview(reviewId) {
    if (confirm('Are you sure you want to delete this review?')) {
        fetch(`/api/reviews/${reviewId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                loadReviews(); // Reload reviews
            } else {
                alert(data.message || 'Failed to delete review');
            }
        })
        .catch(error => {
            console.error('Error deleting review:', error);
            alert('Failed to delete review');
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Load reviews when page loads
    loadReviews();
    
    // Handle review form submission
    const reviewForm = document.getElementById('review-submit-form');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitReview();
        });
    }
    
    // Handle borrow button click
    const borrowBtn = document.querySelector('.borrow-btn');
    if (borrowBtn) {
        borrowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const bookId = this.dataset.bookId;
            const bookTitle = this.dataset.bookTitle;
            const hasOwner = this.dataset.hasOwner === 'true';

            // If book has owner, get proposed due date
            let proposedDueDate = null;
            if (hasOwner) {
                const dueDateInput = document.getElementById('proposedDueDate');
                if (dueDateInput) {
                    proposedDueDate = dueDateInput.value;
                }
            }

            borrowBookRequest(bookId, bookTitle, proposedDueDate, this);
        });
    }

    // Handle return button click
    const returnBtn = document.querySelector('.return-btn');
    if (returnBtn) {
        returnBtn.addEventListener('click', function() {
            const bookId = this.dataset.bookId;
            const bookTitle = this.dataset.bookTitle;

            returnBook(bookId, bookTitle, this);
        });
    }
});

{% if show_borrow_success_modal %}
// Show borrow success modal
document.addEventListener('DOMContentLoaded', function() {
    const modalHTML = `
        <div class="modal fade show" id="borrowSuccessModal" tabindex="-1" aria-labelledby="borrowSuccessModalLabel" aria-hidden="true" style="display: block; background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content glass-card">
                    <div class="modal-body text-center p-5">
                        <div class="mb-4">
                            <i class="fas fa-paper-plane fa-5x text-success mb-3"></i>
                            <h3 class="text-success mb-3">Request Sent Successfully!</h3>
                            <p class="text-muted mb-4">
                                Your borrow request for "<strong>{{ book_title }}</strong>" has been sent to {{ poster_name }}.
                            </p>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                You'll receive a notification once the book owner responds to your request.
                            </div>
                        </div>
                        
                        {% if achievements %}
                        <div class="achievement-notifications mb-4">
                            <h5 class="text-warning mb-3">
                                <i class="fas fa-trophy me-2"></i>Achievements Unlocked!
                            </h5>
                            {% for achievement in achievements %}
                            <div class="alert alert-warning d-flex align-items-center mb-2">
                                <i class="fas fa-trophy me-2"></i>
                                <strong>{{ achievement.name }}</strong>
                                <span class="ms-auto badge bg-warning">+{{ achievement.points }} points</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="button" class="btn btn-primary btn-lg px-4" onclick="closeBorrowModal()">
                                <i class="fas fa-check me-2"></i>Okay
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="goToDashboard()">
                                <i class="fas fa-tachometer-alt me-2"></i>View My Books
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Prevent closing modal by clicking outside
    const modal = document.getElementById('borrowSuccessModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            e.preventDefault();
        }
    });
});

// Close borrow success modal
function closeBorrowModal() {
    const modal = document.getElementById('borrowSuccessModal');
    if (modal) {
        modal.remove();
    }
}

// Go to dashboard from modal
function goToDashboard() {
    window.location.href = '/dashboard';
}
// New function to handle borrow requests with due date
async function borrowBookRequest(bookId, bookTitle, proposedDueDate, buttonElement) {
    try {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending Request...';
        
        // Create form data
        const formData = new FormData();
        if (proposedDueDate) {
            formData.append('proposed_due_date', proposedDueDate);
        }

        // Make POST request to borrow route
        const response = await fetch(`/borrow/${bookId}`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            // Instead of replacing content, just reload the page which will show the modal
            window.location.reload();
        } else {
            console.error('Error response:', response.status);
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="fas fa-download me-2"></i>Request to Borrow';
            alert('Failed to send borrow request. Please try again.');
        }
    } catch (error) {
        console.error('Error borrowing book:', error);
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="fas fa-download me-2"></i>Request to Borrow';
        alert('Failed to send borrow request. Please try again.');
    }
}

// Star rating functionality
document.addEventListener('DOMContentLoaded', function() {
    const ratingInput = document.querySelector('.rating-input');
    if (ratingInput) {
        const stars = ratingInput.querySelectorAll('.star');
        const radioInputs = ratingInput.querySelectorAll('input[type="radio"]');
        let selectedRating = 0;
        
        // Handle star clicks
        stars.forEach((star, index) => {
            const rating = index + 1;
            
            star.addEventListener('click', function() {
                selectedRating = rating;
                // Check the corresponding radio button
                radioInputs[index].checked = true;
                updateStarDisplay();
            });
            
            star.addEventListener('mouseenter', function() {
                updateStarDisplay(rating);
            });
        });
        
        // Reset to selected rating on mouse leave
        ratingInput.addEventListener('mouseleave', function() {
            updateStarDisplay();
        });
        
        function updateStarDisplay(hoverRating = null) {
            const displayRating = hoverRating || selectedRating;
            stars.forEach((star, index) => {
                star.classList.remove('active', 'hover');
                if (index < displayRating) {
                    if (hoverRating) {
                        star.classList.add('hover');
                    } else {
                        star.classList.add('active');
                    }
                }
            });
        }
    }
});

{% endif %}
</script>
{% endblock %}