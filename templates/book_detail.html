{% extends "base.html" %}

{% block title %}{{ book.title }} - ReadingTrail{% endblock %}

{% set category_vn = {
    'Tiểu thuyết': 'Tiểu thuyết',
    'Phi tiểu thuyết': 'Phi tiểu thuyết',
    'Trinh thám': 'Trinh thám',
    'Lãng mạn': 'Lãng mạn',
    'Khoa học viễn tưởng': 'Khoa học viễn tưởng',
    'Kỳ ảo': 'Kỳ ảo',
    'Tiểu sử': 'Tiểu sử',
    'Lịch sử': 'Lịch sử',
    'Tự lực': 'Tự lực',
    'Kinh doanh': 'Kinh doanh',
    'Công nghệ': 'Công nghệ',
    'Văn học cổ điển': 'Văn học cổ điển',
    'Giáo dục': 'Giáo dục',
    'Sức khỏe & Thể hình': 'Sức khỏe & Thể hình',
    'Du lịch': 'Du lịch',
    'Nấu ăn': 'Nấu ăn',
    'Nghệ thuật & Thiết kế': 'Nghệ thuật & Thiết kế',
    'Triết học': 'Triết học',
    'Tôn giáo & Tâm linh': 'Tôn giáo & Tâm linh',
    'Chính trị': 'Chính trị',
    'Tâm lý học': 'Tâm lý học',
    'Tội phạm có thật': 'Tội phạm có thật',
    'Kinh dị': 'Kinh dị',
    'Giật gân': 'Giật gân',
    'Thanh thiếu niên': 'Thanh thiếu niên',
    'Thiếu nhi': 'Thiếu nhi',
    'Thơ': 'Thơ',
    'Kịch': 'Kịch',
    'Truyện tranh & Tiểu thuyết đồ họa': 'Truyện tranh & Tiểu thuyết đồ họa',
    'Khác': 'Khác'
} %}

{% block content %}
<div class="container py-4">
    <!-- Nút quay lại -->
    <div class="row mb-3">
        <div class="col">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Về danh mục
            </a>
        </div>
    </div>

    <!-- Thông tin sách -->
    <div class="row">
        <div class="col-xl-4 col-lg-5 col-md-6 mb-4">
            <div class="card glass-card sticky-top" style="top: 100px;">
                <div class="book-cover-container-large">
                    <img src="{{ book.cover_url }}" 
                         class="card-img-top book-cover-large" 
                         alt="{{ book.title }}"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22450%22 viewBox=%220 0 300 450%22><rect width=%22300%22 height=%22450%22 fill=%22%23666%22/><text x=%22150%22 y=%22225%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2224%22>Không có ảnh</text></svg>'">

                    <!-- Badge trạng thái mượn -->
                    {% if is_borrowed %}
                    <div class="position-absolute top-0 end-0 m-3">
                        <span class="badge glass-badge bg-success">
                            <i class="fas fa-check me-1"></i>
                            <span class="d-none d-sm-inline">Đang </span>mượn
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-xl-8 col-lg-7 col-md-6">
            <div class="card glass-card">
                <div class="card-body">
                    <h1 class="card-title display-5 mb-3">{{ book.title }}</h1>

                    <div class="book-meta mb-4">
                        <h4 class="text-muted mb-3">
                            <i class="fas fa-user me-2"></i>Tác giả: {{ book.author }}
                        </h4>

                        {% if book.poster %}
                        <div class="d-flex align-items-center mt-2">
                            <span class="text-muted me-2">
                                <i class="fas fa-user-edit me-1"></i>Người đăng:
                            </span>
                            <a href="{{ url_for('profile.view_profile', user_id=book.poster.id, from_book=book.id) }}"
                               class="btn btn-outline-primary btn-sm glass-button rounded-pill">
                              <i class="fas fa-user me-1"></i>{{ book.poster.get_full_name() or book.poster.username }}
                            </a>


                        </div>
                        {% endif %}
                    </div>


                        <div class="row g-2 g-sm-3 mb-4">
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center flex-wrap">
                                    <i class="fas fa-tag me-2 text-muted"></i>
                                    <strong class="me-2">Thể loại:</strong>
                                    <span class="badge bg-secondary">{{ category_vn.get(book.category, book.category) }}</span>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar me-2 text-muted"></i>
                                    <strong class="me-2">Xuất bản:</strong>
                                    <span>{{ book.publication_year }}</span>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-alt me-2 text-muted"></i>
                                    <strong class="me-2">Số trang:</strong>
                                    <span>{{ book.pages }}</span>
                                </div>
                            </div>
                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-map-marker-alt me-2 text-muted"></i>
                                    <strong class="me-2">Vị trí:</strong>
                                    <span>{{ book.location }}</span>
                                </div>
                            </div>


                            <div class="col-12 col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-clock me-2 text-muted"></i>
                                    <strong class="me-2">Thời gian mượn:</strong>
                                    <span>{{ book.borrow_duration_weeks or 2 }} tuần ({{ (book.borrow_duration_weeks or 2) * 7 }} ngày)</span>
                                </div>
                            </div>


                            </div>
                            </div>


                    <div class="book-description mb-4">
                        <h5><i class="fas fa-info-circle me-2"></i>Mô tả</h5>
                        <p class="lead">{{ book.description }}</p>
                    </div>

                    <!-- Đánh giá & Nhận xét -->
                    <div class="ratings-section mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h5><i class="fas fa-star me-2"></i>Đánh giá & Nhận xét về sách</h5>
                            {% if current_user.is_authenticated %}
                                {% if book.poster and current_user.id == book.poster.id %}
                            <div class="alert alert-warning mb-3 fw-semibold" style="color: #FFD700;">
                                <i class="fas fa-exclamation-triangle me-2" style="color: #FFD700;"></i>
                                Bạn là người đăng sách này, nên không thể tự đánh giá.
                            </div>
                                {% else %}
                                    <button class="btn btn-outline-primary btn-sm" onclick="toggleReviewForm()">
                                        <i class="fas fa-plus me-1"></i>Thêm đánh giá
                                    </button>
                                {% endif %}
                            {% endif %}

                        </div>

                        <!-- Hiển thị đánh giá trung bình -->
                        <div class="rating-summary mb-3" id="rating-summary">
                            <div class="d-flex align-items-center">
                                <div class="rating-stars me-3" id="average-stars">
                                    <!-- Ngôi sao sẽ được tạo bởi JS -->
                                </div>
                                <span class="rating-text" id="rating-text">Đang tải...</span>
                            </div>
                        </div>

                        <!-- Form đánh giá (ẩn mặc định) -->
                        {% if current_user.is_authenticated %}
                        <div class="review-form mb-4" id="review-form" style="display: none;">
                            <div class="glass-card p-3">
                                <h6>Viết đánh giá</h6>
                                <form id="review-submit-form">
                                    <div class="mb-3">
                                        <label class="form-label">Xếp hạng</label>
                                        <div class="rating-input">
                                            <input type="radio" name="rating" value="1" id="star1">
                                            <label for="star1" class="star">★</label>
                                            <input type="radio" name="rating" value="2" id="star2">
                                            <label for="star2" class="star">★</label>
                                            <input type="radio" name="rating" value="3" id="star3">
                                            <label for="star3" class="star">★</label>
                                            <input type="radio" name="rating" value="4" id="star4">
                                            <label for="star4" class="star">★</label>
                                            <input type="radio" name="rating" value="5" id="star5">
                                            <label for="star5" class="star">★</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="review-text" class="form-label">Nhận xét</label>
                                        <textarea class="form-control glass-input" id="review-text" rows="3" 
                                                placeholder="Chia sẻ suy nghĩ của bạn về cuốn sách này..."></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary glass-button">Gửi đánh giá</button>
                                        <button type="button" class="btn btn-secondary glass-button" onclick="toggleReviewForm()">Hủy</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Danh sách đánh giá -->
                        <div class="reviews-list" id="reviews-list">
                            <!-- Reviews sẽ được tải bằng JS -->
                        </div>
                    </div>

                    <!-- Nút hành động -->
                    <div class="action-buttons">
                        {% if current_user.is_authenticated %}
                            {% if book.poster and book.poster.id == current_user.id %}
                        <div class="alert alert-info mb-3 text-white">

                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Đây là sách của bạn:</strong> Bạn không thể mượn sách của chính mình.
                                </div>
                                <div class="d-grid gap-2 d-sm-flex flex-wrap mb-3">
                                    <button class="btn btn-secondary btn-lg glass-button flex-fill" disabled>
                                        <i class="fas fa-user me-2"></i>Sách của bạn
                                    </button>
                                </div>
                            {% elif not is_borrowed %}
                                {% if book.poster %}
                                <div class="mb-3">
                                    <label for="proposedDueDate" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Ngày trả dự kiến
                                    </label>
                                    <input type="date" 
                                           class="form-control glass-input" 
                                           id="proposedDueDate" 
                                           min="{{ (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d') }}"
                                           value="{{ (datetime.now() + timedelta(weeks=2)).strftime('%Y-%m-%d') }}">
                                    <small class="text-muted">Thời gian trả có thể được thỏa thuận</small>
                                </div>
                                {% endif %}

                                <div class="d-grid gap-2 d-sm-flex flex-wrap mb-3">
                           <!--         <button class="btn btn-success btn-lg glass-button borrow-btn flex-fill" 
                                            data-book-id="{{ book.id }}"
                                            data-book-title="{{ book.title }}"
                                            data-has-owner="{{ 'true' if book.poster else 'false' }}"
                                        <i class="fas fa-download me-2"></i>
                                      <!--  {% if book.poster %}Yêu cầu mượn{% else %}Mượn ngay{% endif %} --!>
                                    </button>
                                </div>
                            {% else %}
                                <div class="alert alert-success mb-3">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Đã mượn:</strong> Bạn đang mượn cuốn sách này.
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Yêu cầu đăng nhập:</strong> Vui lòng đăng nhập để mượn sách từ thư viện.
                            </div>
                            <div class="d-grid gap-2 d-sm-flex flex-wrap mb-3">
                                <a href="{{ url_for('login') }}" class="btn btn-primary btn-lg glass-button flex-fill">
                                    <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập để mượn
                                </a>
                                <a href="{{ url_for('signup') }}" class="btn btn-outline-primary btn-lg glass-button flex-fill">
                                    <i class="fas fa-user-plus me-2"></i>Đăng ký
                                </a>
                            </div>
                        {% endif %}

                        <div class="d-grid gap-2 d-sm-flex flex-wrap">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary glass-button flex-fill">
                                <i class="fas fa-user me-2"></i>
                                <span class="d-none d-sm-inline">Xem </span>sách của tôi
                            </a>

                            <a href="{{ url_for('book_discussion', book_id=book.id) }}" class="btn btn-outline-secondary glass-button flex-fill">
                                <i class="fas fa-comments me-2"></i>Thảo luận
                            </a>

                            {% if book.poster and current_user.is_authenticated and book.poster.id != current_user.id %}
                            <a href="{{ url_for('private_chat', recipient_id=book.poster.id, book_id=book.id) }}" class="btn btn-outline-success glass-button flex-fill">
                                <i class="fas fa-comments me-2"></i>
                                <span class="d-none d-sm-inline">Nhắn tin với </span>tác giả
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Thông tin mượn sách -->

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block styles %}
<style>

/* Rating Stars Styling */
.rating-stars {
    display: flex;
    gap: 2px;
}

.rating-stars .star {
    color: #ffc107;
    font-size: 1.2rem;
}

.rating-stars .star.empty {
    color: #666;
}

/* Interactive Rating Input */
.rating-input {
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    gap: 5px;
}

.rating-input input[type="radio"] {
    display: none;
}

.rating-input .star {
    font-size: 2rem;
    color: #dee2e6;
    cursor: pointer;
    transition: color 0.2s ease;
}

.rating-input .star.active {
    color: #ffc107;
}

.rating-input .star.hover {
    color: #ffc107;
}

/* Review Cards */
.review-card {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 1rem;
    margin-bottom: 1rem;
}

.review-meta {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.7);
}

.review-content {
    margin-top: 0.5rem;
}

.rating-summary {
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

</style>
{% endblock %}

{% block scripts %}
<script>
const bookId = {{ book.id }};

    // Hiển thị đúng số sao người dùng chọn (1–5)
    function renderStars(rating, maxStars = 5) {
        let starsHtml = '';
        for (let i = 1; i <= maxStars; i++) {
            if (i <= rating) {
                starsHtml += '<span class="star" style="color:#ffc107;">★</span>';
            } else {
                starsHtml += '<span class="star" style="color:#666;">★</span>';
            }
        }
        return starsHtml;
    }

    function displayReviews(reviews) {
        const reviewsList = document.getElementById('reviews-list');

        if (reviews.length === 0) {
            reviewsList.innerHTML = '<p class="text-muted">Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá cuốn sách này!</p>';
            return;
        }

        let reviewsHtml = '';
        reviews.forEach(review => {
            const stars = renderStars(review.rating || 0); // hiển thị đúng số sao người dùng chọn
            reviewsHtml += `
                <div class="review-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="review-header">
                            <div class="d-flex align-items-center mb-2">
                                <strong class="me-2">${review.user_full_name || review.username}</strong>
                                <div class="rating-stars me-2">${stars}</div>
                                <small class="review-meta">${review.time_ago || ''}</small>
                            </div>
                        </div>
                        ${review.user_id === {{ current_user.id if current_user.is_authenticated else 'null' }} ? 
                            `<button class="btn btn-sm btn-outline-danger" onclick="deleteReview(${review.id})">
                                <i class="fas fa-trash"></i>
                            </button>` : ''}
                    </div>
                    ${review.review_text ? `<div class="review-content">${review.review_text}</div>` : ''}
                </div>
            `;
        });

        reviewsList.innerHTML = reviewsHtml;
    }



function toggleReviewForm() {
    const form = document.getElementById('review-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function loadReviews() {
    fetch(`/api/books/${bookId}/reviews`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReviews(data.reviews);
                updateRatingSummary(data.reviews);
            } else {
                console.error('Không thể tải đánh giá:', data.error);
            }
        })
        .catch(error => {
            console.error('Lỗi tải đánh giá:', error);
        });
}

function displayReviews(reviews) {
    const reviewsList = document.getElementById('reviews-list');
    
    if (reviews.length === 0) {
        reviewsList.innerHTML = '<p class="text-muted">Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá cuốn sách này!</p>';
        return;
    }
    
    let reviewsHtml = '';
    reviews.forEach(review => {
        reviewsHtml += `
            <div class="review-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="review-header">
                        <div class="d-flex align-items-center mb-2">
                            <strong class="me-2">${review.user_full_name || review.username}</strong>
                            <div class="rating-stars me-2">
                                ${renderStars(review.rating)}
                            </div>
                            <small class="review-meta">${review.time_ago}</small>
                        </div>
                    </div>
                    ${review.user_id === {{ current_user.id if current_user.is_authenticated else 'null' }} ? 
                        `<button class="btn btn-sm btn-outline-danger" onclick="deleteReview(${review.id})">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                </div>
                ${review.review_text ? `<div class="review-content">${review.review_text}</div>` : ''}
            </div>
        `;
    });
    
    reviewsList.innerHTML = reviewsHtml;
}

function updateRatingSummary(reviews) {
    const summaryElement = document.getElementById('rating-summary');
    const starsElement = document.getElementById('average-stars');
    const textElement = document.getElementById('rating-text');
    
    if (reviews.length === 0) {
        starsElement.innerHTML = renderStars(0);
        textElement.textContent = 'Chưa có đánh giá';
        return;
    }
    
    const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);
    const averageRating = totalRating / reviews.length;
    const roundedRating = Math.round(averageRating * 10) / 10;
    
    starsElement.innerHTML = renderStars(Math.round(averageRating));
    textElement.textContent = `${roundedRating}/5 (${reviews.length} đánh giá)`;
}

function submitReview() {
    const form = document.getElementById('review-submit-form');
    const formData = new FormData(form);
    const rating = formData.get('rating');
    const reviewText = document.getElementById('review-text').value.trim();
    
    if (!rating) {
        alert('Vui lòng chọn xếp hạng');
        return;
    }
    
    const reviewData = {
        rating: parseInt(rating),
        review_text: reviewText
    };
    
    fetch(`/api/books/${bookId}/reviews`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(reviewData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            toggleReviewForm();
            form.reset();
            loadReviews(); // Tải lại đánh giá
        } else {
            alert(data.message || 'Không thể gửi đánh giá');
        }
    })
    .catch(error => {
        console.error('Lỗi gửi đánh giá:', error);
        alert('Không thể gửi đánh giá');
    });
}

function deleteReview(reviewId) {
    if (confirm('Bạn có chắc muốn xóa đánh giá này?')) {
        fetch(`/api/reviews/${reviewId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                loadReviews(); // Tải lại đánh giá
            } else {
                alert(data.message || 'Không thể xóa đánh giá');
            }
        })
        .catch(error => {
            console.error('Lỗi xóa đánh giá:', error);
            alert('Không thể xóa đánh giá');
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Tải đánh giá khi trang load
    loadReviews();
    
    // Xử lý submit form đánh giá
    const reviewForm = document.getElementById('review-submit-form');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitReview();
        });
    }
    
    // Xử lý nút mượn sách
    const borrowBtn = document.querySelector('.borrow-btn');
    if (borrowBtn) {
        borrowBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const bookId = this.dataset.bookId;
            const bookTitle = this.dataset.bookTitle;
            const hasOwner = this.dataset.hasOwner === 'true';

            let proposedDueDate = null;
            if (hasOwner) {
                const dueDateInput = document.getElementById('proposedDueDate');
                if (dueDateInput) {
                    proposedDueDate = dueDateInput.value;
                }
            }

            borrowBookRequest(bookId, bookTitle, proposedDueDate, this);
        });
    }

    // Xử lý nút trả sách
    const returnBtn = document.querySelector('.return-btn');
    if (returnBtn) {
        returnBtn.addEventListener('click', function() {
            const bookId = this.dataset.bookId;
            const bookTitle = this.dataset.bookTitle;

            returnBook(bookId, bookTitle, this);
        });
    }
});

{% if show_borrow_success_modal %}
// Hiển thị modal mượn sách thành công
document.addEventListener('DOMContentLoaded', function() {
    const modalHTML = `
        <div class="modal fade show" id="borrowSuccessModal" tabindex="-1" aria-labelledby="borrowSuccessModalLabel" aria-hidden="true" style="display: block; background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content glass-card">
                    <div class="modal-body text-center p-5">
                        <div class="mb-4">
                            <i class="fas fa-paper-plane fa-5x text-success mb-3"></i>
                            <h3 class="text-success mb-3">Gửi yêu cầu thành công!</h3>
                            <p class="text-muted mb-4">
                                Yêu cầu mượn sách "<strong>{{ book_title }}</strong>" đã được gửi đến {{ poster_name }}.
                            </p>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Bạn sẽ nhận được thông báo khi chủ sách phản hồi yêu cầu của bạn.
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="button" class="btn btn-primary btn-lg px-4" onclick="closeBorrowModal()">
                                <i class="fas fa-check me-2"></i>Đồng ý
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="goToDashboard()">
                                <i class="fas fa-tachometer-alt me-2"></i>Xem sách của tôi
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    const modal = document.getElementById('borrowSuccessModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            e.preventDefault();
        }
    });
});

function closeBorrowModal() {
    const modal = document.getElementById('borrowSuccessModal');
    if (modal) {
        modal.remove();
    }
}

function goToDashboard() {
    window.location.href = '/dashboard';
}

async function borrowBookRequest(bookId, bookTitle, proposedDueDate, buttonElement) {
    try {
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi yêu cầu...';
        
        const formData = new FormData();
        if (proposedDueDate) {
            formData.append('proposed_due_date', proposedDueDate);
        }

        const response = await fetch(`/borrow/${bookId}`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            window.location.reload();
        } else {
            console.error('Lỗi phản hồi:', response.status);
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="fas fa-download me-2"></i>Yêu cầu mượn';
            alert('Không thể gửi yêu cầu mượn. Vui lòng thử lại.');
        }
    } catch (error) {
        console.error('Lỗi mượn sách:', error);
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="fas fa-download me-2"></i>Yêu cầu mượn';
        alert('Không thể gửi yêu cầu mượn. Vui lòng thử lại.');
    }
}

// Chức năng xếp hạng sao
document.addEventListener('DOMContentLoaded', function() {
    const ratingInput = document.querySelector('.rating-input');
    if (ratingInput) {
        const stars = ratingInput.querySelectorAll('.star');
        const radioInputs = ratingInput.querySelectorAll('input[type="radio"]');
        let selectedRating = 0;
        
        stars.forEach((star, index) => {
            const rating = index + 1;
            
            star.addEventListener('click', function() {
                selectedRating = rating;
                radioInputs[index].checked = true;
                updateStarDisplay();
            });
            
            star.addEventListener('mouseenter', function() {
                updateStarDisplay(rating);
            });
        });
        
        ratingInput.addEventListener('mouseleave', function() {
            updateStarDisplay();
        });
        
        function updateStarDisplay(hoverRating = null) {
            const displayRating = hoverRating || selectedRating;
            stars.forEach((star, index) => {
                star.classList.remove('active', 'hover');
                if (index < displayRating) {
                    if (hoverRating) {
                        star.classList.add('hover');
                    } else {
                        star.classList.add('active');
                    }
                }
            });
        }
    }
});

{% endif %}
</script>
{% endblock %}
