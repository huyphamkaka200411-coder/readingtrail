{% extends "base.html" %}

{% block title %}{{ poster.get_full_name() or poster.username }} - Hồ sơ người đăng{% endblock %}

{% block content %}
<div class="profile-background 
     {% if user_profile and user_profile.background_style %}profile-bg-{{ user_profile.background_style }}{% else %}profile-bg-default{% endif %}
     {% if user_profile and user_profile.background_overlay %}with-overlay{% endif %}">
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Thẻ hồ sơ người đăng -->
            <div class="card glass-card mb-4">
                {% set user_profile = poster.profile %}
                <div class="card-header glass-header" 
                     {% if user_profile and user_profile.banner_style %}
                     style="background: {{ user_profile.banner_style }}; backdrop-filter: blur(20px);"
                     {% endif %}>
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-0">
                                <i class="fas fa-user-circle me-2"></i>
                                {{ poster.get_full_name() or poster.username }}
                                {% if user_profile and user_profile.custom_title %}
                                    <span class="custom-title ms-2" style="color: {{ user_profile.title_color }};">
                                        {{ user_profile.custom_title }}
                                    </span>
                                {% endif %}
                            </h4>
                            <p class="mb-0 text-muted">
                                <i class="fas fa-envelope me-1"></i>{{ poster.email }}
                            </p>
                            {% set rank_info = poster.get_rank_info() %}
                            <div class="mt-2">
                                <span class="badge glass-badge">
                                    <i class="fas {{ rank_info.current_rank.icon }}" style="color: {{ rank_info.current_rank.color }}"></i>
                                    {{ rank_info.current_rank.name }} ({{ rank_info.total_points }} điểm)
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            {% if current_user.is_authenticated and current_user.id != poster.id %}
                            <a href="{{ url_for('private_chat', recipient_id=poster.id) }}" class="btn btn-primary glass-button">
                                <i class="fas fa-comment me-2"></i>Trò chuyện riêng
                            </a>
                            {% elif current_user.is_authenticated and current_user.id == poster.id %}
                            <button type="button" class="btn btn-secondary glass-button" data-bs-toggle="modal" data-bs-target="#customizeProfileModal">
                                <i class="fas fa-palette me-2"></i>Tùy chỉnh hồ sơ
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <h5 class="stat-number">{{ posted_books|length }}</h5>
                                    <p class="stat-label">Sách đã đăng</p>
                                </div>
                                <div class="stat-item">
                                    <h5 class="stat-number">{{ poster.created_at.strftime('%B %Y') }}</h5>
                                    <p class="stat-label">Thành viên từ</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="profile-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Giới thiệu</h6>
                                <p class="text-muted">
                                    Thành viên cộng đồng tích cực chia sẻ kiến thức thông qua việc cho mượn sách.
                                    {% if poster.get_full_name() %}
                                    Được biết đến là {{ poster.get_full_name() }} trong cộng đồng.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Phần sách đã đăng -->
            <div class="card glass-card">
                <div class="card-header glass-header">
                    <h5 class="mb-0">
                        <i class="fas fa-books me-2"></i>
                        Sách được đăng bởi {{ poster.get_full_name() or poster.username }}
                    </h5>
                </div>
                
                <div class="card-body">
                    {% if posted_books %}
                        <div class="row">
                            {% for book in posted_books %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card book-card h-100">
                                    <div class="book-cover-container">
                                        <img src="{{ book.cover_url or 'https://via.placeholder.com/300x400?text=No+Cover' }}" 
                                             class="card-img-top book-cover" 
                                             alt="{{ book.title }}"
                                             onerror="this.src='https://via.placeholder.com/300x400?text=No+Cover'">
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h6 class="card-title">{{ book.title }}</h6>
                                        <p class="card-text text-muted small">
                                            <i class="fas fa-user me-1"></i>{{ book.author }}
                                        </p>
                                        <p class="card-text text-muted small">
                                            <i class="fas fa-tag me-1"></i>{{ book.category }}
                                        </p>
                                        {% if book.description and ('Price:' in book.description or 'Contact:' in book.description) %}
                                        <div class="book-contact-info">
                                            {% for line in book.description.split('\n') %}
                                                {% if 'Price:' in line or 'Contact:' in line %}
                                                    <small class="text-info">{{ line }}</small><br>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        <div class="mt-auto">
                                            <a href="{{ url_for('book_detail', book_id=book.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye me-1"></i>Xem chi tiết
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-books text-center py-5">
                            <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Chưa đăng sách nào</h5>
                            <p class="text-muted">{{ poster.get_full_name() or poster.username }} chưa đăng sách nào lên thư viện.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Nút quay lại -->
            <div class="text-center mt-4">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary glass-button">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại danh mục
                </a>
            </div>
        </div>
    </div>
</div>

<style>
/* Kiểu dáng hồ sơ người đăng */
.glass-header {
    background: rgba(255, 255, 255, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(20px);
    border-radius: 15px 15px 0 0;
}

.profile-stats {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.stat-item {
    text-align: center;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 5px;
}

.stat-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    margin-bottom: 0;
}

.profile-info {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    height: 100%;
}

.book-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.book-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    background: rgba(255, 255, 255, 0.1);
}

.book-cover-container {
    height: 200px;
    overflow: hidden;
    position: relative;
}

.book-cover {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.book-card:hover .book-cover {
    transform: scale(1.05);
}

.book-contact-info {
    background: rgba(74, 144, 226, 0.1);
    border: 1px solid rgba(74, 144, 226, 0.3);
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 10px;
}

.empty-books {
    height: 300px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* Điều chỉnh responsive */
@media (max-width: 768px) {
    .profile-stats {
        flex-direction: row;
        justify-content: space-around;
        margin-bottom: 20px;
    }
    
    .stat-item {
        flex: 1;
        margin: 0 5px;
    }
    
    .stat-number {
        font-size: 1.4rem;
    }
}

/* Kiểu modal tùy chỉnh hồ sơ */
.banner-option {
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 5px;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.05);
}

.banner-option:hover {
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.banner-option.selected {
    border-color: #4a90e2;
    background: rgba(74, 144, 226, 0.1);
}

.banner-preview {
    height: 60px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin-bottom: 10px;
    backdrop-filter: blur(10px);
}

.banner-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
}

.banner-name {
    font-weight: bold;
}

.banner-cost {
    color: #ffd700;
    font-weight: bold;
}

.color-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.color-option {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.color-option:hover {
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
}

.color-option.selected {
    border-color: #4a90e2;
    transform: scale(1.2);
}

.custom-title {
    font-size: 0.9rem;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

.glass-alert {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    backdrop-filter: blur(10px);
}

.glass-input {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: white;
    backdrop-filter: blur(10px);
}

.glass-input:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: #4a90e2;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
}

.glass-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

/* Chủ đề nền hồ sơ */
.profile-background {
    min-height: 100vh;
    position: relative;
    padding: 0;
}

.profile-bg-default {
    background: #0d1117;
}

.profile-bg-space {
    background: linear-gradient(135deg, #000428 0%, #004e92 100%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="white" opacity="0.8"/><circle cx="80" cy="30" r="0.5" fill="white" opacity="0.6"/><circle cx="40" cy="70" r="0.8" fill="white" opacity="0.9"/><circle cx="90" cy="80" r="0.3" fill="white" opacity="0.5"/><circle cx="10" cy="90" r="0.6" fill="white" opacity="0.7"/></svg>');
    background-attachment: fixed;
    background-size: 100% 100%, 20px 20px;
}

.profile-bg-ocean {
    background: linear-gradient(135deg, #667db6 0%, #0082c8 25%, #0052cc 50%, #667db6 100%);
    background-size: 400% 400%;
    animation: ocean-wave 8s ease-in-out infinite;
    background-attachment: fixed;
}

@keyframes ocean-wave {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.profile-bg-forest {
    background: linear-gradient(135deg, #134e5e 0%, #71b280 100%),
                radial-gradient(circle at 30% 60%, rgba(0, 100, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(34, 139, 34, 0.4) 0%, transparent 50%);
    background-attachment: fixed;
}

.profile-bg-neon {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #533483 100%);
    position: relative;
    background-attachment: fixed;
}

.profile-bg-neon::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        linear-gradient(90deg, transparent 0%, rgba(255, 0, 255, 0.1) 25%, transparent 50%, rgba(0, 255, 255, 0.1) 75%, transparent 100%);
    animation: neon-glow 3s ease-in-out infinite alternate;
    pointer-events: none;
    z-index: -1;
}

@keyframes neon-glow {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
}

.profile-bg-aurora {
    background: linear-gradient(135deg, #000428 0%, #004e92 25%, #009ffd 50%, #00d2ff 100%);
    background-size: 300% 300%;
    animation: aurora-dance 10s ease-in-out infinite;
    background-attachment: fixed;
}

@keyframes aurora-dance {
    0%, 100% { background-position: 0% 50%; }
    25% { background-position: 100% 0%; }
    50% { background-position: 100% 100%; }
    75% { background-position: 0% 100%; }
}

.with-overlay::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    pointer-events: none;
    z-index: -1;
}

.profile-background .container {
    position: relative;
    z-index: 1;
}
</style>

<!-- Modal tùy chỉnh hồ sơ -->
{% if current_user.is_authenticated and current_user.id == poster.id %}
<div class="modal fade" id="customizeProfileModal" tabindex="-1" aria-labelledby="customizeProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card">
            <div class="modal-header glass-header">
                <h5 class="modal-title" id="customizeProfileModalLabel">
                    <i class="fas fa-palette me-2"></i>Tùy chỉnh hồ sơ của bạn
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info glass-alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Điểm của bạn:</strong> <span id="currentPoints">{{ rank_info.total_points }}</span>
                </div>

                <!-- Phần xem trước -->
                <div class="mb-4">
                    <h6><i class="fas fa-eye me-2"></i>Xem trước</h6>
                    <div class="card glass-card">
                        <div class="card-header glass-header" id="previewHeader">
                            <h4 class="mb-0">
                                <i class="fas fa-user-circle me-2"></i>
                                {{ poster.get_full_name() or poster.username }}
                                <span class="custom-title ms-2" id="previewTitle" style="color: #ffffff;"></span>
                            </h4>
                        </div>
                    </div>
                </div>

                <!-- Chọn banner -->
                <div class="mb-4">
                    <h6><i class="fas fa-image me-2"></i>Banner hồ sơ</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="banner-option" data-style="" data-cost="0">
                                <div class="banner-preview glass-header">Mặc định</div>
                                <div class="banner-info">
                                    <span class="banner-name">Mặc định</span>
                                    <span class="banner-cost">Miễn phí</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="banner-option" data-style="linear-gradient(135deg, #667eea 0%, #764ba2 100%)" data-cost="50">
                                <div class="banner-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Tím xanh</div>
                                <div class="banner-info">
                                    <span class="banner-name">Tím xanh</span>
                                    <span class="banner-cost">50 điểm</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="banner-option" data-style="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" data-cost="75">
                                <div class="banner-preview" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Hồng đỏ</div>
                                <div class="banner-info">
                                    <span class="banner-name">Hồng đỏ</span>
                                    <span class="banner-cost">75 điểm</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="banner-option" data-style="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)" data-cost="100">
                                <div class="banner-preview" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">Xanh đại dương</div>
                                <div class="banner-info">
                                    <span class="banner-name">Xanh đại dương</span>
                                    <span class="banner-cost">100 điểm</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="banner-option" data-style="linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)" data-cost="125">
                                <div class="banner-preview" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">Xanh bạc hà</div>
                                <div class="banner-info">
                                    <span class="banner-name">Xanh bạc hà</span>
                                    <span class="banner-cost">125 điểm</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="banner-option" data-style="linear-gradient(135deg, #fa709a 0%, #fee140 100%)" data-cost="150">
                                <div class="banner-preview" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">Hoàng hôn</div>
                                <div class="banner-info">
                                    <span class="banner-name">Hoàng hôn</span>
                                    <span class="banner-cost">150 điểm</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phần tiêu đề tùy chỉnh -->
                <div class="mb-4">
                    <h6><i class="fas fa-tag me-2"></i>Tiêu đề tùy chỉnh</h6>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="customTitle">Tiêu đề tùy chỉnh (tối đa 30 ký tự)</label>
                                <input type="text" class="form-control glass-input" id="customTitle" maxlength="30" placeholder="Nhập tiêu đề tùy chỉnh của bạn">
                                <div class="form-text">Chi phí: 100 điểm</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label>Màu tiêu đề</label>
                            <div class="color-options">
                                <div class="color-option" data-color="#ffffff" data-cost="0" style="background: #ffffff;" title="Trắng - Miễn phí"></div>
                                <div class="color-option" data-color="#ffd700" data-cost="10" style="background: #ffd700;" title="Vàng - 10 điểm"></div>
                                <div class="color-option" data-color="#ff6b6b" data-cost="20" style="background: #ff6b6b;" title="Đỏ - 20 điểm"></div>
                                <div class="color-option" data-color="#4ecdc4" data-cost="25" style="background: #4ecdc4;" title="Xanh ngọc - 25 điểm"></div>
                                <div class="color-option" data-color="#45b7d1" data-cost="30" style="background: #45b7d1;" title="Xanh dương - 30 điểm"></div>
                                <div class="color-option" data-color="#96ceb4" data-cost="40" style="background: #96ceb4;" title="Xanh lá - 40 điểm"></div>
                                <div class="color-option" data-color="#dda0dd" data-cost="50" style="background: #dda0dd;" title="Tím - 50 điểm"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tóm tắt chi phí -->
                <div class="alert alert-warning glass-alert">
                    <h6><i class="fas fa-calculator me-2"></i>Tóm tắt chi phí</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div>Banner: <span id="bannerCost">0</span> điểm</div>
                            <div>Tiêu đề tùy chỉnh: <span id="titleCost">0</span> điểm</div>
                            <div>Màu tiêu đề: <span id="colorCost">0</span> điểm</div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-end">
                                <strong>Tổng chi phí: <span id="totalCost">0</span> điểm</strong><br>
                                <span class="text-muted">Còn lại: <span id="remainingPoints">{{ rank_info.total_points }}</span> điểm</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary glass-button" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary glass-button" id="saveProfileBtn">Lưu thay đổi</button>
            </div>
        </div>
    </div>
</div>

<script>
// Chức năng tùy chỉnh hồ sơ
document.addEventListener('DOMContentLoaded', function() {
    const currentPoints = {{ rank_info.total_points }};
    let selectedBanner = "{{ user_profile.banner_style if user_profile else '' }}";
    let selectedBannerCost = 0;
    let selectedTitle = "{{ user_profile.custom_title if user_profile else '' }}";
    let selectedTitleColor = "{{ user_profile.title_color if user_profile else '#ffffff' }}";
    let titleCost = selectedTitle ? 100 : 0;
    let colorCost = 0;

    // Khởi tạo form với giá trị hiện tại
    document.getElementById('customTitle').value = selectedTitle;
    document.getElementById('previewTitle').textContent = selectedTitle;
    document.getElementById('previewTitle').style.color = selectedTitleColor;
    
    // Đặt banner hiện tại là đã chọn
    document.querySelectorAll('.banner-option').forEach(option => {
        if (option.dataset.style === selectedBanner) {
            option.classList.add('selected');
            selectedBannerCost = parseInt(option.dataset.cost);
        }
    });
    
    // Đặt màu tiêu đề hiện tại là đã chọn
    document.querySelectorAll('.color-option').forEach(option => {
        if (option.dataset.color === selectedTitleColor) {
            option.classList.add('selected');
            colorCost = parseInt(option.dataset.cost);
        }
    });

    // Chọn banner
    document.querySelectorAll('.banner-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.banner-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            selectedBanner = this.dataset.style;
            selectedBannerCost = parseInt(this.dataset.cost);
            
            // Cập nhật xem trước
            const previewHeader = document.getElementById('previewHeader');
            if (selectedBanner) {
                previewHeader.style.background = selectedBanner;
                previewHeader.style.backdropFilter = 'blur(20px)';
            } else {
                previewHeader.style.background = '';
                preview