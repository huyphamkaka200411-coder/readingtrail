{% extends "base.html" %}

{% block title %}Store - L.E.A.F{% endblock %}

{% block content %}
<div class="store-page">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-store me-2"></i>
            Power-Up Store
        </h1>
        <p class="page-description">Enhance your library experience with powerful upgrades</p>
        <div class="rank-requirement-badge">
            <span class="badge bg-success">
                <i class="fas fa-book-open me-1"></i>Bookworm+ Rank Required
            </span>
        </div>
    </div>

    <!-- User Points Display -->
    {% if current_user.is_authenticated %}
    <div class="points-card mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="points-display">
                    <div class="points-amount">
                        <i class="fas fa-coins me-2"></i>{{ user_points }}
                    </div>
                    <div class="points-label">Available Points</div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <a href="{{ url_for('achievements') }}" class="btn btn-outline-primary">
                    <i class="fas fa-trophy me-2"></i>Earn More Points
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Power-ups Available for Purchase -->
    <div class="section-header mb-3">
        <h3><i class="fas fa-shopping-cart me-2"></i>Available Power-ups</h3>
    </div>

    <div class="row mb-5">
        {% for powerup in powerups %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="powerup-card glass-card">
                <div class="powerup-header" style="background: linear-gradient(135deg, {{ powerup.color }}40, {{ powerup.color }}20);">
                    <div class="powerup-icon">
                        <i class="fas {{ powerup.icon }}" style="color: {{ powerup.color }};"></i>
                    </div>
                    <h4 class="powerup-name">{{ powerup.name }}</h4>
                </div>
                
                <div class="powerup-body">
                    <p class="powerup-description">{{ powerup.description }}</p>
                    
                    <div class="powerup-details">
                        {% if powerup.duration_hours %}
                        <div class="detail-item">
                            <i class="fas fa-clock me-2"></i>
                            <span>Duration: {{ powerup.duration_hours }} hours</span>
                        </div>
                        {% else %}
                        <div class="detail-item">
                            <i class="fas fa-zap me-2"></i>
                            <span>One-time use</span>
                        </div>
                        {% endif %}
                        
                        <div class="detail-item">
                            <i class="fas fa-bolt me-2"></i>
                            <span>Effect: {{ (powerup.effect_value * 100)|int if powerup.effect_value else 'Variable' }}{% if powerup.powerup_type == 'double_points' %}% boost{% endif %}</span>
                        </div>
                    </div>
                </div>
                
                <div class="powerup-footer">
                    <div class="powerup-cost">
                        <i class="fas fa-coins me-1"></i>{{ powerup.cost }} points
                    </div>
                    
                    {% if current_user.is_authenticated %}
                        {% if user_points >= powerup.cost %}
                        <button class="btn btn-primary btn-purchase" data-powerup-id="{{ powerup.id }}" data-cost="{{ powerup.cost }}">
                            <i class="fas fa-shopping-cart me-1"></i>Purchase
                        </button>
                        {% else %}
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-lock me-1"></i>Not Enough Points
                        </button>
                        {% endif %}
                    {% else %}
                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary">
                        <i class="fas fa-sign-in-alt me-1"></i>Login to Purchase
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% if not powerups %}
        <div class="col-12">
            <div class="empty-state glass-card text-center p-5">
                <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                <h4>No Power-ups Available</h4>
                <p class="text-muted">Power-ups are coming soon! Check back later.</p>
                <a href="{{ url_for('seed_powerups') }}" class="btn btn-primary">
                    <i class="fas fa-seedling me-1"></i>Seed Power-ups (Admin)
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Your Power-ups (Purchased) -->
    {% if current_user.is_authenticated and user_powerups %}
    <div class="section-header mb-3">
        <h3><i class="fas fa-inventory me-2"></i>Your Power-ups</h3>
    </div>

    <div class="row">
        {% for user_powerup in user_powerups %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="user-powerup-card glass-card">
                <div class="powerup-header" style="background: linear-gradient(135deg, {{ user_powerup.powerup.color }}40, {{ user_powerup.powerup.color }}20);">
                    <div class="powerup-icon">
                        <i class="fas {{ user_powerup.powerup.icon }}" style="color: {{ user_powerup.powerup.color }};"></i>
                    </div>
                    <h5 class="powerup-name">{{ user_powerup.powerup.name }}</h5>
                </div>
                
                <div class="powerup-body">
                    <div class="powerup-status mb-3">
                        {% if user_powerup.is_consumed %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-check me-1"></i>Used
                        </span>
                        {% elif user_powerup.is_active and not user_powerup.is_expired() %}
                        <span class="badge bg-success">
                            <i class="fas fa-bolt me-1"></i>Active
                        </span>
                        {% elif user_powerup.is_expired() %}
                        <span class="badge bg-warning">
                            <i class="fas fa-clock me-1"></i>Expired
                        </span>
                        {% else %}
                        <span class="badge bg-primary">
                            <i class="fas fa-pause me-1"></i>Ready
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="powerup-info">
                        <div class="info-item">
                            <small class="text-muted">Purchased:</small>
                            <span>{{ user_powerup.purchased_at.strftime('%d/%m/%Y %H:%M') if user_powerup.purchased_at else 'Unknown' }}</span>
                        </div>
                        
                        {% if user_powerup.activated_at %}
                        <div class="info-item">
                            <small class="text-muted">Activated:</small>
                            <span>{{ user_powerup.activated_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                        
                        {% if user_powerup.expires_at %}
                        <div class="info-item">
                            <small class="text-muted">Expires:</small>
                            <span>{{ user_powerup.expires_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        </div>
                        {% endif %}
                        
                        {% if user_powerup.leeched_user_id %}
                        <div class="info-item">
                            <small class="text-muted">Target:</small>
                            <span class="text-info">{{ user_powerup.leeched_user.get_full_name() if user_powerup.leeched_user else 'Unknown User' }}</span>
                        </div>
                        {% endif %}
                        
                        {% if user_powerup.leeched_points and user_powerup.leeched_points > 0 %}
                        <div class="info-item">
                            <small class="text-muted">Points Gained:</small>
                            <span class="text-success">+{{ user_powerup.leeched_points }} so far</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="powerup-footer">
                    {% if not user_powerup.is_consumed and not (user_powerup.is_active and not user_powerup.is_expired()) %}
                    <button class="btn btn-success btn-activate w-100" data-user-powerup-id="{{ user_powerup.id }}">
                        <i class="fas fa-play me-1"></i>Activate
                    </button>
                    {% elif user_powerup.is_active and not user_powerup.is_expired() and user_powerup.time_remaining() %}
                    <div class="text-center">
                        <small class="text-muted">Time remaining:</small><br>
                        <span class="fw-bold text-success">{{ user_powerup.time_remaining() }}</span>
                    </div>
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-check-circle me-1"></i>Completed
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Purchase Confirmation Modal -->
<div class="modal fade" id="purchaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart me-2"></i>Confirm Purchase
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to purchase this power-up?</p>
                <div id="purchase-details" class="alert alert-info">
                    <!-- Purchase details will be filled by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-purchase">
                    <i class="fas fa-check me-1"></i>Confirm Purchase
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Activation Modal -->
<div class="modal fade" id="activationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bolt me-2"></i>Power-up Activated!
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="activation-details" class="text-center">
                    <!-- Activation details will be filled by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Awesome!</button>
            </div>
        </div>
    </div>
</div>

<style>
.store-page {
    padding: 20px 0;
}

.page-header {
    text-align: center;
    margin-bottom: 2rem;
}

.page-title {
    font-size: 2.5rem;
    font-weight: bold;
    color: #fff;
    margin-bottom: 0.5rem;
}

.page-description {
    font-size: 1.1rem;
    color: #b8c2cc;
    margin-bottom: 0;
}

.points-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 1.5rem;
}

.points-display {
    text-align: center;
}

.points-amount {
    font-size: 2rem;
    font-weight: bold;
    color: #ffd700;
    margin-bottom: 0.25rem;
}

.points-label {
    color: #b8c2cc;
    font-size: 0.9rem;
}

.section-header h3 {
    color: #fff;
    font-weight: 600;
}

.powerup-card, .user-powerup-card {
    height: 100%;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: hidden;
}

.powerup-card:hover, .user-powerup-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.powerup-header {
    padding: 1.5rem;
    text-align: center;
    border-radius: 15px 15px 0 0;
}

.powerup-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.powerup-name {
    color: #fff;
    font-weight: 600;
    margin: 0;
}

.powerup-body {
    padding: 1.5rem;
    flex-grow: 1;
}

.powerup-description {
    color: #b8c2cc;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.powerup-details {
    margin-bottom: 1rem;
}

.detail-item {
    color: #d1d9e1;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.powerup-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.powerup-cost {
    font-size: 1.1rem;
    font-weight: 600;
    color: #ffd700;
}

.powerup-status {
    text-align: center;
}

.powerup-info .info-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    padding-bottom: 0.25rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.empty-state {
    background: rgba(255, 255, 255, 0.05);
}

.glass-modal .modal-content {
    background: rgba(33, 37, 41, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

@media (max-width: 768px) {
    .page-title {
        font-size: 2rem;
    }
    
    .points-amount {
        font-size: 1.5rem;
    }
    
    .powerup-footer {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .powerup-footer .btn {
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Purchase functionality
    let selectedPowerup = null;
    
    document.querySelectorAll('.btn-purchase').forEach(button => {
        button.addEventListener('click', function() {
            const powerupId = this.dataset.powerupId;
            const cost = this.dataset.cost;
            const powerupName = this.closest('.powerup-card').querySelector('.powerup-name').textContent;
            
            selectedPowerup = {
                id: powerupId,
                name: powerupName,
                cost: cost
            };
            
            const userPoints = {{ user_points if current_user.is_authenticated else 0 }};
            const remainingPoints = userPoints - cost;
            
            document.getElementById('purchase-details').innerHTML = `
                <strong>Power-up:</strong> ${powerupName}<br>
                <strong>Cost:</strong> <i class="fas fa-coins"></i> ${cost} points<br>
                <strong>Remaining after purchase:</strong> <i class="fas fa-coins"></i> ${remainingPoints} points
            `;
            
            new bootstrap.Modal(document.getElementById('purchaseModal')).show();
        });
    });
    
    document.getElementById('confirm-purchase').addEventListener('click', function() {
        if (!selectedPowerup) return;
        
        const button = this;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
        
        fetch('/purchase_powerup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                powerup_id: selectedPowerup.id
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh to show updated points and purchased power-ups
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while purchasing the power-up');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check me-1"></i>Confirm Purchase';
            bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();
        });
    });
    
    // Activation functionality
    document.querySelectorAll('.btn-activate').forEach(button => {
        button.addEventListener('click', function() {
            const userPowerupId = this.dataset.userPowerupId;
            const powerupName = this.closest('.user-powerup-card').querySelector('.powerup-name').textContent;
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Activating...';
            
            fetch('/activate_powerup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_powerup_id: userPowerupId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('activation-details').innerHTML = `
                        <i class="fas fa-bolt fa-3x text-success mb-3"></i>
                        <h4>${powerupName} Activated!</h4>
                        <p class="text-muted">${data.message}</p>
                    `;
                    new bootstrap.Modal(document.getElementById('activationModal')).show();
                    
                    // Refresh after modal is closed
                    document.getElementById('activationModal').addEventListener('hidden.bs.modal', function() {
                        location.reload();
                    }, { once: true });
                } else {
                    alert('Error: ' + data.message);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-play me-1"></i>Activate';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while activating the power-up');
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-play me-1"></i>Activate';
            });
        });
    });
});
</script>
{% endblock %}